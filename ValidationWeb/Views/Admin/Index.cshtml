@model AdminIndexViewModel

<div class="row">
    <div class="col-2">
        <div class="list-group" id="admin-list-tab" role="tablist">
            <a class="list-group-item list-group-item-action" id="list-error-threshold-list" data-toggle="list" href="#list-error-threshold" role="tab"
               onclick="loadDefaultTab()">School Years</a>
            <a class="list-group-item list-group-item-action" id="list-submissioncycles-list" data-toggle="list" href="#list-submissioncycles" role="tab"
               onclick="loadNonDefaultTab('submissioncycles')">Submission Cycles</a>
            <a class="list-group-item list-group-item-action" id="list-messages-list" data-toggle="list" href="#list-messages" role="tab" aria-controls="messages">Rule Management</a>
            <a class="list-group-item list-group-item-action" id="list-announcements-list" data-toggle="list" href="#list-announcements" role="tab" aria-controls="settings"
               onclick="loadNonDefaultTab('announcements')">Announcements</a>            
        </div>
    </div>
    <div class="col-10">
        <div class="tab-content" id="nav-tabContent">
            <div class="tab-pane fade" id="list-error-threshold" role="tabpanel" aria-labelledby="list-error-threshold-list">
                @Html.Partial("Partials/ErrorThresholds", Model.YearsOpenForDataSubmission)
            </div>
            <div class="tab-pane fade" id="list-submissioncycles" role="tabpanel" aria-labelledby="list-submissioncycles-list">
                @Html.Partial("Partials/SubmissionCycleList", @Model.SubmissionCycles)
            </div>
            <div class="tab-pane fade" id="list-messages" role="tabpanel" aria-labelledby="list-messages-list">...</div>
            <div class="tab-pane fade" id="list-announcements" role="tabpanel" aria-labelledby="list-announcements-list">
                @Html.Partial("Partials/Announcements", @Model.Announcements)
            </div>
        </div>
    </div>
</div>

@*Modal Section*@
@Html.Partial("Partials/AddSchoolYearModal")

@Html.Hidden("tabParam", @Request.QueryString["tab"])


@section scripts {
    <script>
        /** All Error Threshold JS Functionality **/
        $("#error-threshold-warning-button").on("click", function() {
            $("#error-threshold-warning").hide();
        });

        function loadNonDefaultTab(tabName) {
            let location = window.location.href;
            let queryStringIndex = window.location.href.indexOf('?');
            if (queryStringIndex > -1) {
                //window.location.href = window.location.href.slice(0, queryStringIndex);
                location = location.slice(0, queryStringIndex);
            }
            window.location.href = `${location}?tab=${tabName}`;
        }


        function loadAnnouncementsTab() {
            /***
            let urlIsOnTabAnnouncements = window.location.href.includes('tab=announcements');
            if (!urlIsOnTabAnnouncements) {
                window.location.href += '?tab=announcements';
            }
            ***/
            let location = window.location.href;
            let queryStringIndex = window.location.href.indexOf('?');
            if (queryStringIndex > -1) {
                //window.location.href = window.location.href.slice(0, queryStringIndex);
                location = location.slice(0, queryStringIndex);
            }
            window.location.href = `${location}?tab=announcements`;
        }

        function loadSubmissionCyclesTab() {
            /***
            let urlIsOnTabSubmissionCycles = window.location.href.includes('tab=submissioncycles');
            if (!urlIsOnTabSubmissionCycles) {
                window.location.href += '?tab=submissioncycles';
            }
            ***/
            let location = window.location.href;
            let queryStringIndex = window.location.href.indexOf('?');
            if (queryStringIndex > -1) {
                //window.location.href = window.location.href.slice(0, queryStringIndex);
                location = location.slice(0, queryStringIndex);
            }
            window.location.href = `${location}?tab=submissioncycles`;
        }


        function loadDefaultTab() {
            let queryStringIndex = window.location.href.indexOf('?');
            if (queryStringIndex > -1) {
                window.location.href = window.location.href.slice(0, queryStringIndex);
            }
        }

        function assignsubmissionCycleDateHandlers() {
            $('#edit-submissioncycle-startDate').datetimepicker({ format: 'L' });
            $('#edit-submissioncycle-endDate').datetimepicker({ format: 'L' });
        }

        const ModelFieldMap = {"announcement": ["id", "priority", "message", "contactInfo", "linkUrl", "expiration"],
            "submissioncycle": ["id", "schoolYearId", "collectionId", "startDate", "endDate"]
        };

        var originalThreshold = "";
        $(document).ready(function () {
            let currentTab = $("[name='tabParam']");
            if (currentTab.val()) {
                let tabContentId = `#list-${currentTab.val()}`;
                $(tabContentId).addClass("show active");
                let tabId = `#list-${currentTab.val()}-list`;
                $(tabId).addClass("active");
            }
            else {
                $('#list-error-threshold').addClass("show active");
                $('#list-error-threshold-list').addClass("active");
            }

            var AddAnnouncementPostBackURL = "@Url.Content("~/Admin/AnnouncementAdd")";
            $("#announcement-add").click(function () {
                var options = { "backdrop": "static", keyboard: true };
                $.ajax({
                    type: "GET",
                    url: AddAnnouncementPostBackURL,
                    contentType: "application/json; charset=utf-8",
                    data: {},
                    datatype: "json",
                    success: function (data) {
                        $('#announcement-modal-content').html(data);
                        $('#announcementModal').modal(options);
                        $('#announcementModal').modal('show');

                    },
                    error: function () {
                        alert("Could not open a dialog to create an announcement.");
                    }
                });
            });

            var EditAnnouncementPostBackURL = "@Url.Content("~/Admin/AnnouncementEdit")";
            $(".announcement-edit").click(function () {
                var $buttonClicked = $(this);
                var id = $buttonClicked.attr('data-id');
                var options = { "backdrop": "static", keyboard: true };
                $.ajax({
                    type: "GET",
                    url: EditAnnouncementPostBackURL,
                    contentType: "application/json; charset=utf-8",
                    data: { "Id": id },
                    datatype: "json",
                    success: function (data) {
                        $('#announcement-modal-content').html(data);
                        $('#announcementModal').modal(options);
                        $('#announcementModal').modal('show');
                    },
                    error: function () {
                        alert("Could not retrieve the announcement for editing.");
                    }
                });
            });

            var DeleteAnnouncementPostBackURL = "@Url.Content("~/Admin/DeleteAnnouncement")";
            $(".announcement-delete").click(function () {
                var $buttonClicked = $(this);
                var id = $buttonClicked.attr('data-id');
                if (confirm("Are you sure you want to delete this announcement?")) {
                    $.ajax({
                        type: "DELETE",
                        url: `${DeleteAnnouncementPostBackURL}/${id}`,
                        success: function (data) {
                            location.reload(true);
                        },
                        error: function () {
                            alert("Could not delete the announcement.");
                        }
                    });
                }
            });


            function DeleteModel() {
                let modelName = event.data.modelName;
                let deleteRoute = event.data.deleteRoute;

                var $buttonClicked = $(this);
                var id = $buttonClicked.attr('data-id');
                if (confirm(`Are you sure you want to delete this ${modelName}?`)) {
                    $.ajax({
                        type: "DELETE",
                        url: `${deleteRoute}/${id}`,
                        success: function (data) {
                            location.reload(true);
                        },
                        error: function () {
                            alert(`Could not delete the  ${modelName}.`);
                        }
                    });
                }
            };

            var AddSubmissionCyclePostBackURL = "@Url.Content("~/Admin/AddSubmissionCycle")";
            $("#submissioncycle-add").click(function () {
                var options = { "backdrop": "static", keyboard: true };
                $.ajax({
                    type: "GET",
                    url: AddSubmissionCyclePostBackURL,
                    contentType: "application/json; charset=utf-8",
                    data: {},
                    datatype: "json",
                    success: function (data) {
                        $('#submissioncycle-modal-content').html(data);
                        $('#submissioncycleModal').modal(options);
                        $('#submissioncycleModal').modal('show');

                    },
                    error: function () {
                        alert("Could not open a dialog to create a submission cycle.");
                    }
                });
            });

            function CreateEditModal(event) {
                let modalNameRaw = event.data.modalName;
                let modalEditRoute = event.data.modalEditRoute;
                let modelName = modalNameRaw.toLowerCase();
                let modelModalContent = `#${modelName}-modal-content`;
                let modelModal = `#${modelName}Modal`;
                var $buttonClicked = $(this);
                var id = $buttonClicked.attr('data-id');
                var options = { "backdrop": "static", keyboard: true };
                $.ajax({
                    type: "GET",
                    url: modalEditRoute,
                    contentType: "application/json; charset=utf-8",
                    data: { "Id": id },
                    datatype: "json",
                    success: function (data) {
                        $(modelModalContent).html(data);
                        $(modelModal).modal(options);
                        $(modelModal).modal('show');
                    },
                    error: function () {
                        alert(`Could not retrieve the ${modalNameRaw} for editing.`);
                    }
                });
            }

            var EditSubmissionCycleRoute = "@Url.Content("~/Admin/EditSubmissionCycle")";
            $(".submissioncycle-edit").click({ modalName: "SubmissionCycle", modalEditRoute: EditSubmissionCycleRoute }, CreateEditModal);

            var DeleteSubmissionCycleRoute = "@Url.Content("~/Admin/DeleteSubmissionCycle")";
            $(".submissioncycle-delete").click({ modelName: submissioncycle, deleteRoute: DeleteSubmissionCycleRoute }, DeleteModel);


            $(".save-row").hide();
            $(".cancel-row").hide();
            $(".remove-row").hide();

            $(".edit-row").on("click", function (event) {
                event.preventDefault();
                var tblRow = $(this).closest('tr');

                tblRow.find('.save-row').show();
                tblRow.find('.cancel-row').show();
                tblRow.find('.remove-row').show();

                tblRow.find('.edit-row').hide();

                // Make the whole row editable
                tblRow.find('.row-data')
                    .attr('contenteditable', 'true')
                    //.addClass('bg-warning')
                    .css('padding', '3px')
                    .focus();

                // Save original threshold value just in case of canceled use
                originalThreshold = tblRow.find('.row-data')[0].innerText;
            });

            $(".cancel-row").on('click', function (event) {
                event.preventDefault();

                var tblRow = $(this).closest('tr');

                tblRow.find('.save-row').hide();
                tblRow.find('.cancel-row').hide();
                tblRow.find('.remove-row').hide();

                tblRow.find('.edit-row').show();

                // Make the whole row editable
                tblRow.find('.row-data')
                    .attr('contenteditable', 'false')
                    .removeClass('bg-warning')
                    .removeClass('bg-danger')
                    .css('padding', '');

                // If canceled we can put in the original data they started with.
                tblRow.find('.row-data')[0].innerText = originalThreshold;
            });

            $(".save-row").on('click', function (event) {
                event.preventDefault();
                var tblRow = $(this).closest('tr');

                // Clear all white space with regex
                var threshold = tblRow.find('.row-data')[0].innerText.replace(/\s/g, "");
                var id = tblRow[0].cells[0].innerText;

                // Validate and update the threshold
                if (isNaN(threshold)) {
                    $('#error-threshold-warning').show();
                }
                else {
                    // This is to make sure the threshold does not appear with extra white spaces.
                    tblRow.find('.row-data')[0].innerText = threshold;

                    var successValue = updateThreshold(id, threshold);

                    // Ajax returns a captial T true instead of boolean
                    if (successValue != "True") {
                        $("#error-threshold-warning").show();
                    }
                    // Otherwise return it back to original state.
                    else {
                        tblRow.find('.save-row').hide();
                        tblRow.find('.cancel-row').hide();
                        tblRow.find('.remove-row').hide();

                        tblRow.find('.edit-row').show();

                        tblRow.find('.row-data')
                            .attr('contenteditable', 'false')
                            .removeClass('bg-danger')
                            .removeClass('bg-warning')
                            .css('padding', '');
                    }
                }
            });

            // Setting the end year for the user in the add error threshold.
            $("#add-start-year").change(function () {
                $("#add-end-year").val(Number($("#add-start-year").val()) + 1);
            });

            $('#submissioncycleModal').on('shown.bs.modal', function () {
                setModalHeaderText("submissionCycle", "Submission Cycle");
                assignsubmissionCycleDateHandlers();
                $("#save-submissioncycle").click({ modalName: "SubmissionCycle", additionalFunction: assignsubmissionCycleDateHandlers }, saveModel);
            });

            $('#announcementModal').on('shown.bs.modal', function () {
                setModalHeaderText("announcement", "Announcement");
                $('#edit-announcement-expiration').datetimepicker({ format: 'L' });
                $("#save-announcement").click(saveAnnouncement);
            });
        });

        function saveAnnouncement(event) {
            var SaveAnnouncementPostBackURL = "@Url.Content("~/Admin/SaveAnnouncement")";
            event.preventDefault();
            var id = $('#edit-announcement-id').val();
            var priority = $('#edit-announcement-priority').val();
            if ($.trim(priority).length === 0) {
                priority = 0;
            }
            var message = $('#edit-announcement-message').val();
            var contactInfo = $('#edit-announcement-contactInfo').val();
            var linkUrl = $('#edit-announcement-linkUrl').val();
            var expirationDate = $('#edit-announcement-expiration').val();
            var options = { "backdrop": "static", keyboard: true };
            var dataObj = { id: id, priority: priority, message: message, contactInfo: contactInfo, linkUrl: linkUrl, expiration: expirationDate };
            var jsonData = JSON.stringify(dataObj);
            $.ajax({
                type: "POST",
                url: SaveAnnouncementPostBackURL,
                contentType: "application/json; charset=utf-8",
                data: jsonData,
                datatype: "json",
                success: function (data) {
                    var tempData = $(data);
                    let announcementValidationSummaryContents = "";
                    let announcementValidationSummary = tempData.find('#announcement-validation-summary-row');
                    if (announcementValidationSummary) {
                        announcementValidationSummaryContents = announcementValidationSummary.text();
                    }
                    // If announcementValidationSummaryContents contains more than just whitespace,
                    // then validation summary contains errors, and we should re-show the modal
                    if ($.trim(announcementValidationSummaryContents).length > 0) {
                        $('#announcement-modal-content').html(data);
                        $('#announcementModal').modal(options);
                        $('#announcementModal').modal('show');
                        // Need to reattach event handlers to some of the modal's fields, because
                        // when the modal's HTML got repopulated above, the event handlers disappeared
                        setAnnouncementHeaderText();
                        $('#edit-announcement-expiration').datetimepicker({ format: 'L' });
                        $("#save-announcement").click(saveAnnouncement);
                    }
                    else {
                        let locationUrl = location.href;
                        let urlContainsAnnouncements = locationUrl.includes('announcements');
                        if (!urlContainsAnnouncements) {
                            location.href = `${location.href}?tab=announcements`;
                        }
                        location.reload(true);
                    }
                },
                error: function (data) {
                    $('#announcement-modal-content').html(data);
                    $('#announcementModal').modal(options);
                    $('#announcementModal').modal('show');
                    // Need to reattach event handlers to some of the modal's fields, because
                    // when the modal's HTML got repopulated above, the event handlers disappeared
                    $('#edit-announcement-expiration').datetimepicker({ format: 'L' });
                    $("#save-announcement").click(saveAnnouncement);
                }
            });
        }

        function saveModel(event) {
            event.preventDefault();
            let modalNameRaw = event.data.modalName;
            let additionalFunction = event.data.additionalFunction;
            let modelName = modalNameRaw.toLowerCase();
            var saveRoute = `@Url.Content("~/Admin/Save${modalNameRaw}")`;
            var modelFieldNames = ModelFieldMap[modelName];
            var dataObj = getMappedModel(modelName, modelFieldNames);
            var jsonData = JSON.stringify(dataObj);
            var options = { "backdrop": "static", keyboard: true };
            $.ajax({
                type: "POST",
                url: saveRoute,
                contentType: "application/json; charset=utf-8",
                data: jsonData,
                datatype: "json",
                success: function (data) {
                    var tempData = $(data);
                    let validationSummaryContents = "";
                    let validationSummary = tempData.find(`#${modelName}-validation-summary-row`);
                    if (validationSummary) {
                        validationSummaryContents = validationSummary.text();
                    }
                    // If validationSummaryContents contains more than just whitespace,
                    // then validation summary contains errors, and we should re-show the modal
                    if ($.trim(validationSummaryContents).length > 0) {
                        $(`#${modelName}-modal-content`).html(data);
                        $(`#${modelName}Modal`).modal(options);
                        $(`#${modelName}Modal`).modal('show');
                        // Need to reattach event handlers to some of the modal's fields, because
                        // when the modal's HTML got repopulated above, the event handlers disappeared
                        setModalHeaderText(modelName);
                        if (additionalFunction) {
                            additionalFunction();
                        }
                        $(`#save-${modelName}`).click({ modalName: modalNameRaw, additionalFunction: additionalFunction }, saveModel);
                    }
                    else {
                        let locationUrl = location.href;
                        let urlContainsModelName = locationUrl.includes(modelName + 's');
                        if (!urlContainsModelName) {
                            location.href = `${location.href}?tab=${modelName}s`;
                        }
                        location.reload(true);
                    }
                },
                error: function (data) {
                    $(`#${modelName}-modal-content`).html(data);
                    $(`#${modelName}Modal`).modal(options);
                    $(`#${modelName}Modal`).modal('show');
                    // Need to reattach event handlers to some of the modal's fields, because
                    // when the modal's HTML got repopulated above, the event handlers disappeared
                    if (additionalFunction) {
                        additionalFunction();
                    }
                    $(`#save-${modelName}`).click({ modalName: modalNameRaw, additionalFunction: additionalFunction }, saveModel);
                }
            });
        }

        function getMappedModel(modelName, modelFieldNames) {
            let dataObj = {};
            for (fieldName of modelFieldNames) {
                let fieldSelector = `#edit-${modelName}-${fieldName}`;
                let fieldVal = $(fieldSelector).val();
                dataObj[fieldName] = fieldVal;
            }
            return dataObj;
        }

        function setAnnouncementHeaderText() {
            let announcementHeader = $('#announcement-header');
            var id = $('#edit-announcement-id').val();
            if (id > 0) {
                announcementHeader.text("Edit Announcement");
            }
        }

        function setModalHeaderText(modalName, modalTitle) {
            let announcementHeader = $(`#${modalName}-header`);
            var id = $(`#modal-${modalName}-id`).val();
            if (id > 0) {
                announcementHeader.text(`Edit ${modalTitle}`);
            }
        }

            /***
        function setSubmissionCycleHeaderText() {
            let announcementHeader = $('#announcement-header');
            var id = $('#modal-announcement-id').val();
            if (id > 0) {
                announcementHeader.text("Edit Announcement");
            }
        }
        ***/

        function updateThreshold(id, errorThreshold) {
            var value;
            $.ajax({
                url: '@(Url.Action("UpdateThresholdErrorValue", "Admin"))',
                async: true,
                data: { Id: id, thresholdValue: errorThreshold },
                success: function (result) {
                    value = result;
                }
            });
            return value;
        }

        function submitNewSchoolYears() {
            $("#submit-school-years-form").submit();
        }

        function removeSchoolYear(id, yearsRange) {
            if (confirm("Are you sure you want to delete " + yearsRange + "?")) {
                $.ajax({
                    url: '@(Url.Action("RemoveSchoolYear", "Admin"))',
                    async: false,
                    data: { Id: id },
                    success: function () {
                        location.reload();
                    }
                });
            }
        }
        /** End **/

        /** All Submission Row JS Functionality **/
        $("#collection-list").bind('change', function () {
            $.ajax({
                url: '@(Url.Action("GetSubmissionCyclesByCollectionId", "Admin"))',
                async: true,
                data: { collectionId: $("#collection-list").val() },
                success: function (data) {
                    $("#submission-rows").html(data);
                }
            });
        });

        // Inserting and removing rows for submission cycle.

        function removeSubmissionCycle(id, collectionId, cycleDates) {
            if (confirm("Are you sure you want to delete " + cycleDates + " for " + collectionId +"?")) {
                $.ajax({
                    url: '@(Url.Action("RemoveSubmissionCycle", "Admin"))',
                    async: true,
                    data: { id : id, collectionId : collectionId },
                    success: function (data) {
                        $("#submission-rows").html(data);
                    }
                });
            }
        }

        function addSubmissionCycle() {
            console.log($("#collection-list").val());
            $.ajax({
                url: '@(Url.Action("AddSubmissionCycle", "Admin"))',
                async: true,
                data: { collectionId: $("#collection-list").val(), startDate: $("#start-date-picker").val(), endDate: $("#end-date-picker").val() },
                success: function (data) {
                    $("#submission-rows").html(data);
                }
            });
        }
        /** End **/

    </script>
}